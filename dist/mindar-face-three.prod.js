"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const h=require("three"),y=require("three/addons/renderers/CSS3DRenderer.js"),g=require("./controller-526544b5.js"),w=require("./ui-3a557476.js"),M={BufferGeometry:h.BufferGeometry,BufferAttribute:h.BufferAttribute};class m{constructor({container:n,uiLoading:t="yes",uiScanning:r="yes",uiError:a="yes",filterMinCF:e=null,filterBeta:c=null,userDeviceId:s=null,environmentDeviceId:d=null,disableFaceMirror:u=!1}){this.container=n,this.ui=new w.UI({uiLoading:t,uiScanning:r,uiError:a}),this.controller=new g.Controller({filterMinCF:e,filterBeta:c}),this.disableFaceMirror=u,this.scene=new h.Scene,this.cssScene=new h.Scene,this.renderer=new h.WebGLRenderer({antialias:!0,alpha:!0}),this.cssRenderer=new y.CSS3DRenderer({antialias:!0}),this.renderer.outputEncoding=h.sRGBEncoding,this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new h.PerspectiveCamera,this.userDeviceId=s,this.environmentDeviceId=d,this.anchors=[],this.faceMeshes=[],this.container.appendChild(this.renderer.domElement),this.container.appendChild(this.cssRenderer.domElement),this.shouldFaceUser=!0,window.addEventListener("resize",this._resize.bind(this))}async start(){this.ui.showLoading(),await this._startVideo(),await this._startAR(),this.ui.hideLoading()}stop(){this.video.srcObject.getTracks().forEach(function(t){t.stop()}),this.video.remove(),this.controller.stopProcessVideo()}switchCamera(){this.shouldFaceUser=!this.shouldFaceUser,this.stop(),this.start()}addFaceMesh(){const n=this.controller.createThreeFaceGeometry(M),t=new h.Mesh(n,new h.MeshStandardMaterial({color:16777215}));return t.visible=!1,t.matrixAutoUpdate=!1,this.faceMeshes.push(t),t}addAnchor(n){const t=new h.Group;t.matrixAutoUpdate=!1;const r={group:t,landmarkIndex:n,css:!1};return this.anchors.push(r),this.scene.add(t),r}addCSSAnchor(n){const t=new h.Group;t.matrixAutoUpdate=!1;const r={group:t,landmarkIndex:n,css:!0};return this.anchors.push(r),this.cssScene.add(t),r}_startVideo(){return new Promise((n,t)=>{if(this.video=document.createElement("video"),this.video.setAttribute("autoplay",""),this.video.setAttribute("muted",""),this.video.setAttribute("playsinline",""),this.video.style.position="absolute",this.video.style.top="0px",this.video.style.left="0px",this.video.style.zIndex="-2",this.container.appendChild(this.video),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){this.ui.showCompatibility(),t();return}const r={audio:!1,video:{}};this.shouldFaceUser?this.userDeviceId?r.video.deviceId={exact:this.userDeviceId}:r.video.facingMode="user":this.environmentDeviceId?r.video.deviceId={exact:this.environmentDeviceId}:r.video.facingMode="environment",navigator.mediaDevices.getUserMedia(r).then(a=>{this.video.addEventListener("loadedmetadata",()=>{this.video.setAttribute("width",this.video.videoWidth),this.video.setAttribute("height",this.video.videoHeight),n()}),this.video.srcObject=a}).catch(a=>{console.log("getUserMedia error",a),t()})})}_startAR(){return new Promise(async(n,t)=>{const r=this.video;this.container,this.controller.onUpdate=({hasFace:e,estimateResult:c})=>{for(let s=0;s<this.anchors.length;s++)this.anchors[s].css?this.anchors[s].group.children.forEach(d=>{d.element.style.visibility=e?"visible":"hidden"}):this.anchors[s].group.visible=e;for(let s=0;s<this.faceMeshes.length;s++)this.faceMeshes[s].visible=e;if(e){const{metricLandmarks:s,faceMatrix:d,faceScale:u}=c;for(let o=0;o<this.anchors.length;o++){const l=this.anchors[o].landmarkIndex,i=this.controller.getLandmarkMatrix(l);if(this.anchors[o].css){const v=[.001*i[0],.001*i[1],i[2],i[3],.001*i[4],.001*i[5],i[6],i[7],.001*i[8],.001*i[9],i[10],i[11],.001*i[12],.001*i[13],i[14],i[15]];this.anchors[o].group.matrix.set(...v)}else this.anchors[o].group.matrix.set(...i)}for(let o=0;o<this.faceMeshes.length;o++)this.faceMeshes[o].matrix.set(...d)}},this._resize();const a=this.shouldFaceUser&&!this.disableFaceMirror;await this.controller.setup(a),await this.controller.dummyRun(r),this._resize(),this.controller.processVideo(r),n()})}_resize(){const{renderer:n,cssRenderer:t,camera:r,container:a,video:e}=this;if(!e)return;{this.video.setAttribute("width",this.video.videoWidth),this.video.setAttribute("height",this.video.videoHeight),this.controller.onInputResized(e);const{fov:i,aspect:f,near:v,far:p}=this.controller.getCameraParams();this.camera.fov=i,this.camera.aspect=f,this.camera.near=v,this.camera.far=p,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.video.videoWidth,this.video.videoHeight),this.cssRenderer.setSize(this.video.videoWidth,this.video.videoHeight)}let c,s;const d=e.videoWidth/e.videoHeight,u=a.clientWidth/a.clientHeight;d>u?(s=a.clientHeight,c=s*d):(c=a.clientWidth,s=c/d),e.style.top=-(s-a.clientHeight)/2+"px",e.style.left=-(c-a.clientWidth)/2+"px",e.style.width=c+"px",e.style.height=s+"px",this.shouldFaceUser&&!this.disableFaceMirror?e.style.transform="scaleX(-1)":e.style.transform="scaleX(1)";const o=n.domElement,l=t.domElement;o.style.position="absolute",o.style.top=e.style.top,o.style.left=e.style.left,o.style.width=e.style.width,o.style.height=e.style.height,l.style.position="absolute",l.style.top=e.style.top,l.style.left=e.style.left,l.style.transformOrigin="top left",l.style.transform="scale("+c/parseFloat(l.style.width)+","+s/parseFloat(l.style.height)+")"}}window.MINDAR||(window.MINDAR={});window.MINDAR.FACE||(window.MINDAR.FACE={});window.MINDAR.FACE.MindARThree=m;exports.MindARThree=m;
//# sourceMappingURL=mindar-face-three.prod.js.map
