{"version":3,"file":"mindar-face-three.prod.js","sources":["../src/face-target/three.js"],"sourcesContent":["import { Scene, WebGLRenderer, PerspectiveCamera, sRGBEncoding, Mesh, MeshStandardMaterial, Group } from \"three\";\n//import { CSS3DRenderer } from '../libs/CSS3DRenderer.js';\nimport {CSS3DRenderer} from 'three/addons/renderers/CSS3DRenderer.js'\nimport { Controller } from \"./controller.js\";\nimport { UI } from \"../ui/ui.js\";\nimport {BufferGeometry,BufferAttribute} from \"three\";\nconst THREE={BufferGeometry,BufferAttribute};\n\nexport class MindARThree {\n  constructor({container, uiLoading=\"yes\", uiScanning=\"yes\", uiError=\"yes\", filterMinCF=null, filterBeta=null,\n    userDeviceId = null, environmentDeviceId = null, disableFaceMirror = false,\n  }) {\n    this.container = container;\n    this.ui = new UI({ uiLoading, uiScanning, uiError });\n\n    this.controller = new Controller({\n      filterMinCF: filterMinCF,\n      filterBeta: filterBeta,\n    });\n    this.disableFaceMirror = disableFaceMirror;\n    this.scene = new Scene();\n    this.cssScene = new Scene();\n    this.renderer = new WebGLRenderer({ antialias: true, alpha: true });\n    this.cssRenderer = new CSS3DRenderer({ antialias: true });\n    this.renderer.outputEncoding = sRGBEncoding;\n    this.renderer.setPixelRatio(window.devicePixelRatio);\n    this.camera = new PerspectiveCamera();\n    this.userDeviceId = userDeviceId;\n    this.environmentDeviceId = environmentDeviceId;\n\n    this.anchors = [];\n    this.faceMeshes = [];\n\n    this.container.appendChild(this.renderer.domElement);\n    this.container.appendChild(this.cssRenderer.domElement);\n\n    this.shouldFaceUser = true;\n\n    window.addEventListener('resize', this._resize.bind(this));\n  }\n\n  async start() {\n    this.ui.showLoading();\n    await this._startVideo();\n    await this._startAR();\n    this.ui.hideLoading();\n  }\n\n  stop() {\n    const tracks = this.video.srcObject.getTracks();\n    tracks.forEach(function (track) {\n      track.stop();\n    });\n    this.video.remove();\n    this.controller.stopProcessVideo();\n  }\n\n  switchCamera() {\n    this.shouldFaceUser = !this.shouldFaceUser;\n    this.stop();\n    this.start();\n  }\n\n  addFaceMesh() {\n    const faceGeometry = this.controller.createThreeFaceGeometry(THREE);\n    const faceMesh = new Mesh(faceGeometry, new MeshStandardMaterial({ color: 0xffffff }));\n    faceMesh.visible = false;\n    faceMesh.matrixAutoUpdate = false;\n    this.faceMeshes.push(faceMesh);\n    return faceMesh;\n  }\n\n  addAnchor(landmarkIndex) {\n    const group = new Group();\n    group.matrixAutoUpdate = false;\n    const anchor = { group, landmarkIndex, css: false };\n    this.anchors.push(anchor);\n    this.scene.add(group);\n    return anchor;\n  }\n\n  addCSSAnchor(landmarkIndex) {\n    const group = new Group();\n    group.matrixAutoUpdate = false;\n    const anchor = { group, landmarkIndex, css: true };\n    this.anchors.push(anchor);\n    this.cssScene.add(group);\n    return anchor;\n  }\n\n  _startVideo() {\n    return new Promise((resolve, reject) => {\n      this.video = document.createElement('video');\n\n      this.video.setAttribute('autoplay', '');\n      this.video.setAttribute('muted', '');\n      this.video.setAttribute('playsinline', '');\n      this.video.style.position = 'absolute'\n      this.video.style.top = '0px'\n      this.video.style.left = '0px'\n      this.video.style.zIndex = '-2'\n      this.container.appendChild(this.video);\n\n      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\n        this.ui.showCompatibility();\n        reject();\n        return;\n      }\n\n      const constraints = {\n        audio: false,\n        video: {}\n      };\n      if (this.shouldFaceUser) {\n        if (this.userDeviceId) {\n          constraints.video.deviceId = { exact: this.userDeviceId };\n        } else {\n          constraints.video.facingMode = 'user';\n        }\n      } else {\n        if (this.environmentDeviceId) {\n          constraints.video.deviceId = { exact: this.environmentDeviceId };\n        } else {\n          constraints.video.facingMode = 'environment';\n        }\n      }\n\n      navigator.mediaDevices.getUserMedia(constraints).then((stream) => {\n        this.video.addEventListener('loadedmetadata', () => {\n          this.video.setAttribute('width', this.video.videoWidth);\n          this.video.setAttribute('height', this.video.videoHeight);\n          resolve();\n        });\n        this.video.srcObject = stream;\n      }).catch((err) => {\n        console.log(\"getUserMedia error\", err);\n        reject();\n      });\n    });\n  }\n\n  _startAR() {\n    return new Promise(async (resolve, reject) => {\n      const video = this.video;\n      const container = this.container;\n\n      this.controller.onUpdate = ({ hasFace, estimateResult }) => {\n        for (let i = 0; i < this.anchors.length; i++) {\n          if (this.anchors[i].css) {\n            this.anchors[i].group.children.forEach((obj) => {\n              obj.element.style.visibility = hasFace ? \"visible\" : \"hidden\";\n            });\n          } else {\n            this.anchors[i].group.visible = hasFace;\n          }\n        }\n        for (let i = 0; i < this.faceMeshes.length; i++) {\n          this.faceMeshes[i].visible = hasFace;\n        }\n\n        if (hasFace) {\n          const { metricLandmarks, faceMatrix, faceScale } = estimateResult;\n          for (let i = 0; i < this.anchors.length; i++) {\n            const landmarkIndex = this.anchors[i].landmarkIndex;\n            const landmarkMatrix = this.controller.getLandmarkMatrix(landmarkIndex);\n\n            if (this.anchors[i].css) {\n              const cssScale = 0.001;\n              const scaledElements = [\n                cssScale * landmarkMatrix[0], cssScale * landmarkMatrix[1], landmarkMatrix[2], landmarkMatrix[3],\n                cssScale * landmarkMatrix[4], cssScale * landmarkMatrix[5], landmarkMatrix[6], landmarkMatrix[7],\n                cssScale * landmarkMatrix[8], cssScale * landmarkMatrix[9], landmarkMatrix[10], landmarkMatrix[11],\n                cssScale * landmarkMatrix[12], cssScale * landmarkMatrix[13], landmarkMatrix[14], landmarkMatrix[15]\n              ]\n              this.anchors[i].group.matrix.set(...scaledElements);\n            } else {\n              this.anchors[i].group.matrix.set(...landmarkMatrix);\n            }\n          }\n          for (let i = 0; i < this.faceMeshes.length; i++) {\n            this.faceMeshes[i].matrix.set(...faceMatrix);\n          }\n        }\n      }\n      this._resize();\n\n      const flipFace = this.shouldFaceUser && !this.disableFaceMirror;\n\n      await this.controller.setup(flipFace);\n      await this.controller.dummyRun(video);\n\n      this._resize();\n      this.controller.processVideo(video);\n      resolve();\n    });\n  }\n\n  _resize() {\n    const { renderer, cssRenderer, camera, container, video } = this;\n    if (!video) return;\n\n    if (true) { // only needed if video dimension updated (e.g. when mobile orientation changes)\n      this.video.setAttribute('width', this.video.videoWidth);\n      this.video.setAttribute('height', this.video.videoHeight);\n      this.controller.onInputResized(video);\n\n      const { fov, aspect, near, far } = this.controller.getCameraParams();\n      this.camera.fov = fov;\n      this.camera.aspect = aspect;\n      this.camera.near = near;\n      this.camera.far = far;\n      this.camera.updateProjectionMatrix();\n      this.renderer.setSize(this.video.videoWidth, this.video.videoHeight);\n      this.cssRenderer.setSize(this.video.videoWidth, this.video.videoHeight);\n    }\n\n    let vw, vh; // display css width, height\n    const videoRatio = video.videoWidth / video.videoHeight;\n    const containerRatio = container.clientWidth / container.clientHeight;\n    if (videoRatio > containerRatio) {\n      vh = container.clientHeight;\n      vw = vh * videoRatio;\n    } else {\n      vw = container.clientWidth;\n      vh = vw / videoRatio;\n    }\n\n    video.style.top = (-(vh - container.clientHeight) / 2) + \"px\";\n    video.style.left = (-(vw - container.clientWidth) / 2) + \"px\";\n    video.style.width = vw + \"px\";\n    video.style.height = vh + \"px\";\n\n    if (this.shouldFaceUser && !this.disableFaceMirror) {\n      video.style.transform = 'scaleX(-1)';\n    } else {\n      video.style.transform = 'scaleX(1)';\n    }\n\n    const canvas = renderer.domElement;\n    const cssCanvas = cssRenderer.domElement;\n\n    canvas.style.position = 'absolute';\n    canvas.style.top = video.style.top;\n    canvas.style.left = video.style.left;\n    canvas.style.width = video.style.width;\n    canvas.style.height = video.style.height;\n\n    cssCanvas.style.position = 'absolute';\n    cssCanvas.style.top = video.style.top;\n    cssCanvas.style.left = video.style.left;\n    // cannot set style width for cssCanvas, because that is also used as renderer size\n    //cssCanvas.style.width = video.style.width;\n    //cssCanvas.style.height = video.style.height;\n    cssCanvas.style.transformOrigin = \"top left\";\n    cssCanvas.style.transform = 'scale(' + (vw / parseFloat(cssCanvas.style.width)) + ',' + (vh / parseFloat(cssCanvas.style.height)) + ')';\n  }\n}\n\nif (!window.MINDAR) {\n  window.MINDAR = {};\n}\nif (!window.MINDAR.FACE) {\n  window.MINDAR.FACE = {};\n}\n\nwindow.MINDAR.FACE.MindARThree = MindARThree;\n//window.MINDAR.FACE.THREE = THREE;\n"],"names":["THREE","BufferGeometry","BufferAttribute","MindARThree","container","uiLoading","uiScanning","uiError","filterMinCF","filterBeta","userDeviceId","environmentDeviceId","disableFaceMirror","UI","Controller","Scene","WebGLRenderer","CSS3DRenderer","sRGBEncoding","PerspectiveCamera","track","faceGeometry","faceMesh","Mesh","MeshStandardMaterial","landmarkIndex","group","Group","anchor","resolve","reject","constraints","stream","err","video","hasFace","estimateResult","i","obj","metricLandmarks","faceMatrix","faceScale","landmarkMatrix","scaledElements","flipFace","renderer","cssRenderer","camera","fov","aspect","near","far","vw","vh","videoRatio","containerRatio","canvas","cssCanvas"],"mappings":"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"}